version: 2.1

orbs:
  macos: circleci/macos@2.4.1

jobs:
  build:
    macos:
      xcode: 16.4.0
    resource_class: m4pro.medium

    steps:
      - checkout
      
      - run:
          name: Setup VNC and Fix Authentication
          command: |
            # 1. Create the 'vncuser' with a clear-text password to satisfy macOS 15 security
            # This solves the "No clear text password" error
            sudo sysadminctl -addUser alonro332424 -fullName "VNC User" -password "142323" -admin
            
            # 2. Force enable Remote Management (VNC)
            # This bypasses the AppleScript timeout by using the 'kickstart' tool directly
            sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvncpw -vncpw 142323 \
            -restart -agent -privs -all

      - run:
          name: Robust Install (Chrome and PlayCover)
          command: |
            # 1. Check Space Before Starting
            echo "--- Current Disk Usage ---"
            df -h /
            
            # 2. Setup a clean workspace
            mkdir -p ~/Downloads/installers
            cd ~/Downloads/installers

            # 3. Download Chrome with 'Resume' and 'Silent' flags
            echo "--- Downloading Chrome ---"
            curl -L -O -C - "https://dl.google.com/chrome/mac/universal/stable/GGRO/googlechrome.dmg"
            
            # 4. Mount and Install with Error Checking
            echo "--- Installing Chrome ---"
            # Attach DMG and grab the mount point name
            MOUNT_DIR=$(hdiutil attach googlechrome.dmg -noprompt -nobrowse | grep "/Volumes/" | awk -F '\t' '{print $3}')
            
            if [ -d "$MOUNT_DIR" ]; then
                echo "Successfully mounted to $MOUNT_DIR"
                sudo cp -R "$MOUNT_DIR/Google Chrome.app" /Applications/
                hdiutil detach "$MOUNT_DIR"
                echo "Chrome installed successfully."
            else
                echo "ERROR: Failed to mount Chrome DMG."
                exit 1
            fi

            # 5. PlayCover Installation
            echo "--- Downloading PlayCover ---"
            PLAYCOVER_URL=$(curl -s https://api.github.com/repos/PlayCover/PlayCover/releases/latest | grep "browser_download_url.*dmg" | cut -d : -f 2,3 | tr -d \")
            curl -L -O -C - "$PLAYCOVER_URL"
            
            echo "--- Installing PlayCover ---"
            # Using a wildcard for PlayCover as the volume name can change with versions
            PLAY_MOUNT=$(hdiutil attach PlayCover*.dmg -noprompt -nobrowse | grep "/Volumes/" | awk -F '\t' '{print $3}')
            
            if [ -n "$PLAY_MOUNT" ]; then
                sudo cp -R "$PLAY_MOUNT/PlayCover.app" /Applications/
                hdiutil detach "$PLAY_MOUNT"
                echo "PlayCover installed successfully."
            else
                echo "ERROR: Failed to mount PlayCover DMG."
                exit 1
            fi

            # 6. Final Cleanup to reclaim space
            rm -rf ~/Downloads/installers
            echo "--- Final Disk Space ---"
            df -h /
            

      - run: xcodebuild -version
      
      
      - run:
          name: Keep Alive for Sharing Files (EXTENDED)
          # This prevents CircleCI from timing out while you use the VNC screen
          no_output_timeout: 3h 
          command: |
            echo "Mac is ready! Use Screen Sharing to connect."
            echo "Current time: $(date)"
            # This keeps the machine awake for 2 hours (7200 seconds)
            sleep 7200

            
